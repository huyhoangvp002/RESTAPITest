<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Chá»§ - ÄÄƒng Nháº­p ThÃ nh CÃ´ng</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="page-container">
        <div class="card large">
            <h1 class="welcome-title">ğŸ‰ ChÃ o má»«ng báº¡n!</h1>
            <p class="subtitle">ÄÄƒng nháº­p thÃ nh cÃ´ng vÃ o há»‡ thá»‘ng</p>
            
            <div class="user-info">
                <h3>ğŸ“‹ ThÃ´ng tin tÃ i khoáº£n</h3>
                <p><strong>ğŸ‘¤ TÃ i khoáº£n:</strong> <span id="username">Äang táº£i...</span></p>
                <p><strong>ğŸ“§ Email:</strong> <span id="email">Äang táº£i...</span></p>
                <p><strong>ğŸ“± Sá»‘ Ä‘iá»‡n thoáº¡i:</strong> <span id="phone">Äang táº£i...</span></p>
                <p><strong>ğŸ  Äá»‹a chá»‰:</strong> <span id="address">Äang táº£i...</span></p>
                <p><strong>ğŸ‘¥ Vai trÃ²:</strong> <span id="role">Äang táº£i...</span></p>
            </div>
            
            <div class="nav-links">
                <a href="/static/products.html" class="btn btn-primary">ğŸ›’ Xem sáº£n pháº©m</a>
                <a href="/static/profile.html" class="btn btn-secondary">âš™ï¸ CÃ i Ä‘áº·t</a>
                <button onclick="logout()" class="btn btn-danger">ğŸšª ÄÄƒng xuáº¥t</button>
            </div>
        </div>
    </div>

    <script>
        function getCookie(name) {
            return document.cookie.split("; ").reduce((r, v) => {
                const parts = v.split("=");
                return parts[0] === name ? decodeURIComponent(parts[1]) : r;
            }, "");
        }

        function setCookie(name, value, days) {
            const expires = new Date(Date.now() + days * 864e5).toUTCString();
            document.cookie = name + "=" + encodeURIComponent(value) + "; expires=" + expires + "; path=/";
        }

        function deleteCookie(name) {
            document.cookie = name + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        }

        function logout() {
            if (confirm("ğŸ¤” Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n Ä‘Äƒng xuáº¥t?")) {
                deleteCookie("access_token");
                deleteCookie("refresh_token");
                deleteCookie("cart");
                alert("ğŸ‘‹ ÄÃ£ Ä‘Äƒng xuáº¥t thÃ nh cÃ´ng!");
                window.location.href = "/static/landing_page.html";
            }
        }

        // Simple JWT payload decoder (without verification)
        function parseJWT(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error('Error parsing JWT:', e);
                return null;
            }
        }

        async function loadUserInfo() {
            const token = getCookie("access_token");
            if (!token) {
                alert("âš ï¸ Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i!");
                window.location.href = "/static/login.html";
                return;
            }

            console.log("ğŸ”‘ Token found:", token ? "Yes" : "No");
            
            // Parse JWT to get username
            const payload = parseJWT(token);
            if (!payload || !payload.username) {
                alert("âŒ Token khÃ´ng há»£p lá»‡. Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i!");
                window.location.href = "/static/login.html";
                return;
            }

            console.log("ğŸ‘¤ Username from token:", payload.username);
            console.log("ğŸŒ Using cookie authentication (not Bearer token)");

            try {
                // Backend uses cookie authentication, not Bearer token
                // Use /account/list endpoint which returns current user's account for non-admin users
                console.log("ğŸŒ Calling API: /account/list");
                
                const res = await fetch("/account/list?page_id=1&page_size=5", {
                    method: "GET",
                    headers: { 
                        "Content-Type": "application/json"
                    },
                    credentials: 'include' // Include cookies for authentication
                });

                console.log("ğŸ“¡ Response status:", res.status);

                if (!res.ok) {
                    const errorText = await res.text();
                    console.error("âŒ API Error:", res.status, errorText);
                    
                    if (res.status === 401) {
                        alert("ğŸ”’ Token Ä‘Ã£ háº¿t háº¡n. Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i!");
                        deleteCookie("access_token");
                        deleteCookie("refresh_token");
                        window.location.href = "/static/login.html";
                        return;
                    }
                    
                    throw new Error(`HTTP ${res.status}: ${errorText}`);
                }

                const response = await res.json();
                console.log("âœ… Raw response received:", response);
                console.log("âœ… Response type:", Array.isArray(response) ? "Array" : "Object");
                
                // Handle different response types
                let user;
                if (Array.isArray(response)) {
                    // Admin gets array of accounts, we want the current user's account
                    user = response.find(acc => acc.username === payload.username) || response[0];
                    console.log("âœ… Selected user from array:", user);
                } else {
                    // Regular user gets single account object
                    user = response;
                    console.log("âœ… Single user object:", user);
                }
                
                // Display basic account info
                document.getElementById("username").textContent = user.username || payload.username;
                document.getElementById("email").textContent = "Äang táº£i...";
                document.getElementById("phone").textContent = "Äang táº£i...";
                document.getElementById("address").textContent = "Äang táº£i...";
                document.getElementById("role").textContent = user.role || payload.role || "User";
                
                console.log("ğŸ” User object keys:", Object.keys(user));
                console.log("ğŸ” User ID for account_info:", user.id);
                console.log("ğŸ” User full object:", JSON.stringify(user, null, 2));
                
                // Load additional account info using token authentication
                await loadAccountInfo(token, user.id);
                
            } catch (error) {
                console.error("ğŸ’¥ Error loading user info:", error);
                
                // Show detailed error message
                const errorMsg = error.message || "Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh";
                document.getElementById("username").textContent = `âŒ ${errorMsg}`;
                document.getElementById("email").textContent = "KhÃ´ng thá»ƒ táº£i";
                document.getElementById("phone").textContent = "KhÃ´ng thá»ƒ táº£i";
                document.getElementById("address").textContent = "KhÃ´ng thá»ƒ táº£i";
                document.getElementById("role").textContent = "KhÃ´ng thá»ƒ táº£i";
                
                // Show user-friendly alert
                alert(`âŒ KhÃ´ng thá»ƒ táº£i thÃ´ng tin tÃ i khoáº£n:\n${errorMsg}\n\nVui lÃ²ng kiá»ƒm tra káº¿t ná»‘i máº¡ng hoáº·c Ä‘Äƒng nháº­p láº¡i.`);
            }
        }

        // Load additional account info (name, email, phone, address)
        // Backend uses token authentication, so we don't need to pass ID in URL
        async function loadAccountInfo(token, accountId) {
            console.log(`ğŸ” loadAccountInfo called - using token auth (not URL params)`);
            
            try {
                console.log(`ğŸŒ Calling API: /account_info (token-based authentication)`);
                
                const res = await fetch('/profile', {
                    method: "GET",
                    headers: { "Content-Type": "application/json" },
                    credentials: 'include' // Uses cookie authentication
                });

                console.log(`ğŸ“¡ Response status: ${res.status}`);

                if (res.ok) {
                    const accountInfo = await res.json();
                    console.log(`âœ… SUCCESS with token-based auth:`, accountInfo);
                    
                    document.getElementById("email").textContent = accountInfo.email || "ChÆ°a cáº­p nháº­t";
                    document.getElementById("phone").textContent = accountInfo.phone_number || "ChÆ°a cáº­p nháº­t"; 
                    document.getElementById("address").textContent = accountInfo.address || "ChÆ°a cáº­p nháº­t";
                    return;
                } else {
                    const errorText = await res.text();
                    console.error(`âŒ Token-based account_info failed: ${res.status} - ${errorText}`);
                    
                    if (res.status === 404) {
                        document.getElementById("email").textContent = "ğŸ“ ChÆ°a táº¡o account info";
                        document.getElementById("phone").textContent = "ğŸ“ ChÆ°a táº¡o account info";
                        document.getElementById("address").textContent = "ğŸ“ ChÆ°a táº¡o account info";
                    } else if (res.status === 401 || res.status === 403) {
                        document.getElementById("email").textContent = "ğŸ”’ KhÃ´ng cÃ³ quyá»n truy cáº­p";
                        document.getElementById("phone").textContent = "ğŸ”’ KhÃ´ng cÃ³ quyá»n truy cáº­p";
                        document.getElementById("address").textContent = "ğŸ”’ KhÃ´ng cÃ³ quyá»n truy cáº­p";
                    } else {
                        document.getElementById("email").textContent = `âŒ Lá»—i ${res.status}`;
                        document.getElementById("phone").textContent = `âŒ Lá»—i ${res.status}`;
                        document.getElementById("address").textContent = `âŒ Lá»—i ${res.status}`;
                    }
                }
            } catch (error) {
                console.error("âŒ Error loading account info:", error);
                document.getElementById("email").textContent = "âŒ Lá»—i káº¿t ná»‘i";
                document.getElementById("phone").textContent = "âŒ Lá»—i káº¿t ná»‘i";
                document.getElementById("address").textContent = "âŒ Lá»—i káº¿t ná»‘i";
            }
        }



        // Show account info setup message
        function showAccountInfoSetup() {
            // Create a notification in the user-info section
            const userInfoDiv = document.querySelector('.user-info');
            
            // Remove existing setup message if any
            const existingMsg = document.getElementById('setup-message');
            if (existingMsg) {
                existingMsg.remove();
            }
            
            // Create setup message
            const setupDiv = document.createElement('div');
            setupDiv.id = 'setup-message';
            setupDiv.className = 'alert alert-info';
            setupDiv.innerHTML = `
                <p><strong>ğŸ“‹ Thiáº¿t láº­p thÃ´ng tin cÃ¡ nhÃ¢n</strong></p>
                <p>Báº¡n chÆ°a thiáº¿t láº­p thÃ´ng tin cÃ¡ nhÃ¢n (email, sá»‘ Ä‘iá»‡n thoáº¡i, Ä‘á»‹a chá»‰).</p>
                <div style="margin-top: 10px;">
                    <a href="/static/info.html" class="btn btn-primary" style="display: inline-block; margin-right: 10px;">
                        âœï¸ Thiáº¿t láº­p ngay
                    </a>
                    <button onclick="this.parentElement.parentElement.remove()" class="btn btn-secondary" style="display: inline-block;">
                        â­ï¸ Bá» qua
                    </button>
                </div>
            `;
            
            // Insert after user-info div
            userInfoDiv.insertAdjacentElement('afterend', setupDiv);
        }



        // Load user info when page loads
        loadUserInfo();
    </script>
</body>
</html> 