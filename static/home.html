<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Chủ - Đăng Nhập Thành Công</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="page-container">
        <div class="card large">
            <h1 class="welcome-title">🎉 Chào mừng bạn!</h1>
            <p class="subtitle">Đăng nhập thành công vào hệ thống</p>
            
            <div class="user-info">
                <h3>📋 Thông tin tài khoản</h3>
                <p><strong>👤 Tài khoản:</strong> <span id="username">Đang tải...</span></p>
                <p><strong>📧 Email:</strong> <span id="email">Đang tải...</span></p>
                <p><strong>📱 Số điện thoại:</strong> <span id="phone">Đang tải...</span></p>
                <p><strong>🏠 Địa chỉ:</strong> <span id="address">Đang tải...</span></p>
                <p><strong>👥 Vai trò:</strong> <span id="role">Đang tải...</span></p>
            </div>
            
            <div class="nav-links">
                <a href="/static/products.html" class="btn btn-primary">🛒 Xem sản phẩm</a>
                <a href="/static/profile.html" class="btn btn-secondary">⚙️ Cài đặt</a>
                <button onclick="logout()" class="btn btn-danger">🚪 Đăng xuất</button>
            </div>
        </div>
    </div>

    <script>
        function getCookie(name) {
            return document.cookie.split("; ").reduce((r, v) => {
                const parts = v.split("=");
                return parts[0] === name ? decodeURIComponent(parts[1]) : r;
            }, "");
        }

        function setCookie(name, value, days) {
            const expires = new Date(Date.now() + days * 864e5).toUTCString();
            document.cookie = name + "=" + encodeURIComponent(value) + "; expires=" + expires + "; path=/";
        }

        function deleteCookie(name) {
            document.cookie = name + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        }

        function logout() {
            if (confirm("🤔 Bạn có chắc chắn muốn đăng xuất?")) {
                deleteCookie("access_token");
                deleteCookie("refresh_token");
                deleteCookie("cart");
                alert("👋 Đã đăng xuất thành công!");
                window.location.href = "/static/landing_page.html";
            }
        }

        // Simple JWT payload decoder (without verification)
        function parseJWT(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error('Error parsing JWT:', e);
                return null;
            }
        }

        async function loadUserInfo() {
            const token = getCookie("access_token");
            if (!token) {
                alert("⚠️ Vui lòng đăng nhập lại!");
                window.location.href = "/static/login.html";
                return;
            }

            console.log("🔑 Token found:", token ? "Yes" : "No");
            
            // Parse JWT to get username
            const payload = parseJWT(token);
            if (!payload || !payload.username) {
                alert("❌ Token không hợp lệ. Vui lòng đăng nhập lại!");
                window.location.href = "/static/login.html";
                return;
            }

            console.log("👤 Username from token:", payload.username);
            console.log("🌐 Using cookie authentication (not Bearer token)");

            try {
                // Backend uses cookie authentication, not Bearer token
                // Use /account/list endpoint which returns current user's account for non-admin users
                console.log("🌐 Calling API: /account/list");
                
                const res = await fetch("/account/list?page_id=1&page_size=5", {
                    method: "GET",
                    headers: { 
                        "Content-Type": "application/json"
                    },
                    credentials: 'include' // Include cookies for authentication
                });

                console.log("📡 Response status:", res.status);

                if (!res.ok) {
                    const errorText = await res.text();
                    console.error("❌ API Error:", res.status, errorText);
                    
                    if (res.status === 401) {
                        alert("🔒 Token đã hết hạn. Vui lòng đăng nhập lại!");
                        deleteCookie("access_token");
                        deleteCookie("refresh_token");
                        window.location.href = "/static/login.html";
                        return;
                    }
                    
                    throw new Error(`HTTP ${res.status}: ${errorText}`);
                }

                const response = await res.json();
                console.log("✅ Raw response received:", response);
                console.log("✅ Response type:", Array.isArray(response) ? "Array" : "Object");
                
                // Handle different response types
                let user;
                if (Array.isArray(response)) {
                    // Admin gets array of accounts, we want the current user's account
                    user = response.find(acc => acc.username === payload.username) || response[0];
                    console.log("✅ Selected user from array:", user);
                } else {
                    // Regular user gets single account object
                    user = response;
                    console.log("✅ Single user object:", user);
                }
                
                // Display basic account info
                document.getElementById("username").textContent = user.username || payload.username;
                document.getElementById("email").textContent = "Đang tải...";
                document.getElementById("phone").textContent = "Đang tải...";
                document.getElementById("address").textContent = "Đang tải...";
                document.getElementById("role").textContent = user.role || payload.role || "User";
                
                console.log("🔍 User object keys:", Object.keys(user));
                console.log("🔍 User ID for account_info:", user.id);
                console.log("🔍 User full object:", JSON.stringify(user, null, 2));
                
                // Load additional account info using token authentication
                await loadAccountInfo(token, user.id);
                
            } catch (error) {
                console.error("💥 Error loading user info:", error);
                
                // Show detailed error message
                const errorMsg = error.message || "Lỗi không xác định";
                document.getElementById("username").textContent = `❌ ${errorMsg}`;
                document.getElementById("email").textContent = "Không thể tải";
                document.getElementById("phone").textContent = "Không thể tải";
                document.getElementById("address").textContent = "Không thể tải";
                document.getElementById("role").textContent = "Không thể tải";
                
                // Show user-friendly alert
                alert(`❌ Không thể tải thông tin tài khoản:\n${errorMsg}\n\nVui lòng kiểm tra kết nối mạng hoặc đăng nhập lại.`);
            }
        }

        // Load additional account info (name, email, phone, address)
        // Backend uses token authentication, so we don't need to pass ID in URL
        async function loadAccountInfo(token, accountId) {
            console.log(`🔍 loadAccountInfo called - using token auth (not URL params)`);
            
            try {
                console.log(`🌐 Calling API: /account_info (token-based authentication)`);
                
                const res = await fetch('/profile', {
                    method: "GET",
                    headers: { "Content-Type": "application/json" },
                    credentials: 'include' // Uses cookie authentication
                });

                console.log(`📡 Response status: ${res.status}`);

                if (res.ok) {
                    const accountInfo = await res.json();
                    console.log(`✅ SUCCESS with token-based auth:`, accountInfo);
                    
                    document.getElementById("email").textContent = accountInfo.email || "Chưa cập nhật";
                    document.getElementById("phone").textContent = accountInfo.phone_number || "Chưa cập nhật"; 
                    document.getElementById("address").textContent = accountInfo.address || "Chưa cập nhật";
                    return;
                } else {
                    const errorText = await res.text();
                    console.error(`❌ Token-based account_info failed: ${res.status} - ${errorText}`);
                    
                    if (res.status === 404) {
                        document.getElementById("email").textContent = "📝 Chưa tạo account info";
                        document.getElementById("phone").textContent = "📝 Chưa tạo account info";
                        document.getElementById("address").textContent = "📝 Chưa tạo account info";
                    } else if (res.status === 401 || res.status === 403) {
                        document.getElementById("email").textContent = "🔒 Không có quyền truy cập";
                        document.getElementById("phone").textContent = "🔒 Không có quyền truy cập";
                        document.getElementById("address").textContent = "🔒 Không có quyền truy cập";
                    } else {
                        document.getElementById("email").textContent = `❌ Lỗi ${res.status}`;
                        document.getElementById("phone").textContent = `❌ Lỗi ${res.status}`;
                        document.getElementById("address").textContent = `❌ Lỗi ${res.status}`;
                    }
                }
            } catch (error) {
                console.error("❌ Error loading account info:", error);
                document.getElementById("email").textContent = "❌ Lỗi kết nối";
                document.getElementById("phone").textContent = "❌ Lỗi kết nối";
                document.getElementById("address").textContent = "❌ Lỗi kết nối";
            }
        }



        // Show account info setup message
        function showAccountInfoSetup() {
            // Create a notification in the user-info section
            const userInfoDiv = document.querySelector('.user-info');
            
            // Remove existing setup message if any
            const existingMsg = document.getElementById('setup-message');
            if (existingMsg) {
                existingMsg.remove();
            }
            
            // Create setup message
            const setupDiv = document.createElement('div');
            setupDiv.id = 'setup-message';
            setupDiv.className = 'alert alert-info';
            setupDiv.innerHTML = `
                <p><strong>📋 Thiết lập thông tin cá nhân</strong></p>
                <p>Bạn chưa thiết lập thông tin cá nhân (email, số điện thoại, địa chỉ).</p>
                <div style="margin-top: 10px;">
                    <a href="/static/info.html" class="btn btn-primary" style="display: inline-block; margin-right: 10px;">
                        ✏️ Thiết lập ngay
                    </a>
                    <button onclick="this.parentElement.parentElement.remove()" class="btn btn-secondary" style="display: inline-block;">
                        ⏭️ Bỏ qua
                    </button>
                </div>
            `;
            
            // Insert after user-info div
            userInfoDiv.insertAdjacentElement('afterend', setupDiv);
        }



        // Load user info when page loads
        loadUserInfo();
    </script>
</body>
</html> 