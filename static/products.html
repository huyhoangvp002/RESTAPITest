<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Danh s√°ch s·∫£n ph·∫©m</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <!-- Header m·ªõi cho products.html -->
  <header style="display: flex; align-items: center; justify-content: flex-start; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); padding: 14px 32px; border-radius: 0 0 18px 18px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-bottom: 32px; gap: 32px;">
      <!-- Logo -->
      <div style="display: flex; align-items: center; gap: 12px; cursor: pointer;" onclick="window.location.href='/static/home.html'">
          <img src="/static/images/logo.png" alt="Logo" style="height: 38px; width: 38px; border-radius: 8px; background: #fff;">
          <span style="color: #fff; font-size: 1.3em; font-weight: bold; letter-spacing: 1px;">Trang ch·ªß</span>
      </div>
      <!-- Danh m·ª•c -->
      <nav style="display: flex; align-items: center;">
          <div style="position: relative;">
              <button id="category-btn" style="background: #eebbc3; color: #232946; font-weight: 600; border: none; border-radius: 8px; padding: 10px 22px; font-size: 1em; cursor: pointer;">Danh m·ª•c ‚ñº</button>
              <ul id="category-list" style="display: none; position: absolute; left: 0; top: 110%; background: #fff; color: #232946; min-width: 180px; box-shadow: 0 4px 16px rgba(0,0,0,0.12); border-radius: 8px; list-style: none; margin: 0; padding: 8px 0; z-index: 100;">
                  <li style="padding: 10px 18px; cursor: pointer;" onclick="window.location.href='/static/products.html'">T·∫•t c·∫£ s·∫£n ph·∫©m</li>
                  <!-- Categories s·∫Ω ƒë∆∞·ª£c render ƒë·ªông ·ªü ƒë√¢y -->
              </ul>
          </div>
      </nav>
      <!-- T√†i kho·∫£n -->
      <div style="position: relative; margin-left: auto;">
          <img src="/static/images/default.jpg" alt="Avatar" id="account-avatar" style="height: 38px; width: 38px; border-radius: 50%; object-fit: cover; cursor: pointer; border: 2px solid #eebbc3;">
          <div id="account-dropdown" style="display: none; position: absolute; right: 0; top: 110%; background: #fff; color: #232946; min-width: 180px; box-shadow: 0 4px 16px rgba(0,0,0,0.12); border-radius: 8px; padding: 12px 0; z-index: 100;">
              <div style="padding: 10px 18px; font-weight: 600;">üë§ <span id="dropdown-username">T√†i kho·∫£n</span></div>
              <div style="padding: 10px 18px; cursor: pointer;" onclick="window.location.href='/static/profile.html'">Th√¥ng tin c√° nh√¢n</div>
              <div style="padding: 10px 18px; cursor: pointer; color: #e74c3c; font-weight: 600;" onclick="logout()">ƒêƒÉng xu·∫•t</div>
          </div>
      </div>
      <!-- Gi·ªè h√†ng -->
      <div style="margin-left: 24px; position: relative;">
          <img src="/static/images/cart.png" class="cart-icon" alt="Gi·ªè h√†ng" style="height: 32px; width: 32px; cursor: pointer;" onclick="window.location.href='/static/cart.html'">
          <span id="cart-count" style="position: absolute; top: -8px; right: -12px; background: #e74c3c; color: #fff; font-size: 0.95em; font-weight: bold; border-radius: 50%; padding: 2px 8px;">(0)</span>
      </div>
  </header>

<!-- X√ìA PH·∫¶N L·ªåC DANH M·ª§C ·ªû D∆Ø·ªöI (n·∫øu c√≥) -->
<!-- T√¨m v√† x√≥a to√†n b·ªô kh·ªëi: <div ...>L·ªçc theo danh m·ª•c ... </div> -->

  <div id="productList"></div>

  <script>
    function setCookie(name, value, days = 7) {
      const expires = new Date(Date.now() + days * 864e5).toUTCString();
      document.cookie = name + "=" + encodeURIComponent(value) + "; expires=" + expires + "; path=/";
    }-

    function getCookie(name) {
      return document.cookie.split("; ").reduce((r, v) => {
        const parts = v.split("=");
        return parts[0] === name ? decodeURIComponent(parts[1]) : r;
      }, "");
    }

    function isLoggedIn() {
      return !!getCookie("access_token");
    }

    function updateCartCount() {
      const cart = JSON.parse(getCookie("cart") || "[]");
      const total = cart.reduce((sum, item) => sum + item.quantity, 0);
      document.getElementById("cart-count").textContent = `(${total})`;
    }

    async function loadCategories() {
      // Kh√¥ng c·∫ßn fetch danh m·ª•c cho dropdown d∆∞·ªõi n·ªØa
      loadProducts();
    }

    async function loadProducts(categoryId = "") {
      try {
        const params = new URLSearchParams({ page_id: 1, page_size: 10 });
        if (categoryId) params.append("category_id", categoryId);

        const res = await fetch(`/products/all?${params.toString()}`);
        const products = await res.json();
        const container = document.getElementById("productList");
        container.innerHTML = "";

        products.forEach(p => {
          const card = document.createElement("div");
          card.className = "product-card";

          const img = document.createElement("img");
          img.src = `/static/images/product-${p.id}.jpg`;
          img.className = "product-image";
          img.onerror = () => img.src = "/static/images/default.jpg";

          const name = document.createElement("div");
          name.className = "product-name";
          name.textContent = p.name;

          const price = document.createElement("div");
          price.className = "product-price";
          price.textContent = `${p.discount_price}‚Ç´`;

          const btn = document.createElement("button");
          btn.className = "add-to-cart";
          btn.textContent = "‚ûï Gi·ªè h√†ng";
          btn.onclick = () => handleAddToCart(p.id);

          card.appendChild(img);
          card.appendChild(name);
          card.appendChild(price);
          card.appendChild(btn);
          container.appendChild(card);
        });
      } catch (err) {
        console.error("L·ªói t·∫£i s·∫£n ph·∫©m:", err);
      }
    }

    function handleAddToCart(productId) {
      if (!isLoggedIn()) {
        showLoginPopup();
        return;
      }

      const cart = JSON.parse(getCookie("cart") || "[]");
      const existing = cart.find(item => item.product_id === productId);
      if (existing) {
        existing.quantity += 1;
      } else {
        cart.push({ product_id: productId, quantity: 1 });
      }
      setCookie("cart", JSON.stringify(cart), 7);
      updateCartCount();
      alert("‚úÖ ƒê√£ th√™m v√†o gi·ªè h√†ng!");
    }

    function showLoginPopup() {
      const box = document.createElement("div");
      box.className = "login-popup";

      box.innerHTML = `
        <p><strong>‚ö†Ô∏è B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng.</strong></p>
        <button class="login-btn" onclick="window.location='/static/login.html'">üëâ ƒêƒÉng nh·∫≠p</button>
        <button class="close-btn" onclick="this.parentElement.remove()">ƒê√≥ng</button>
      `;
      document.body.appendChild(box);
    }

    // Dropdown danh m·ª•c
    document.addEventListener('DOMContentLoaded', function() {
        const btn = document.getElementById('category-btn');
        const list = document.getElementById('category-list');
        btn.onclick = function(e) {
            e.stopPropagation();
            list.style.display = list.style.display === 'block' ? 'none' : 'block';
        };
        document.body.onclick = function() { list.style.display = 'none'; };
        // Fetch categories
        fetch('/categories/all', { credentials: 'include' })
            .then(res => res.json())
            .then(data => {
                if (Array.isArray(data)) {
                    data.forEach(cat => {
                        const li = document.createElement('li');
                        li.textContent = cat.name;
                        li.style.padding = '10px 18px';
                        li.style.cursor = 'pointer';
                        li.onclick = () => window.location.href = `/static/products.html?category=${encodeURIComponent(cat.name)}`;
                        list.appendChild(li);
                    });
                }
            });
    });
    // Dropdown t√†i kho·∫£n
    document.getElementById('account-avatar').onclick = function(e) {
        e.stopPropagation();
        const dropdown = document.getElementById('account-dropdown');
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    };
    document.body.onclick = function() {
        document.getElementById('account-dropdown').style.display = 'none';
        const list = document.getElementById('category-list');
        if (list) list.style.display = 'none';
    };
    // Set username in dropdown sau khi loadUserInfo
    function setDropdownUsername(name) {
        document.getElementById('dropdown-username').textContent = name;
    }
    // G·ªçi h√†m n√†y trong loadUserInfo sau khi l·∫•y ƒë∆∞·ª£c username
    loadCategories();
    updateCartCount();
  </script>
</body>
</html>
