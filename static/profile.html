<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üë§ Th√¥ng Tin T√†i Kho·∫£n</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="page-container">
        <div class="card">
            <div class="profile-avatar">
                <img src="/static/images/default.jpg" alt="Avatar" class="avatar-image" id="avatar-img">
            </div>
            
            <h1 class="title">üë§ Th√¥ng Tin T√†i Kho·∫£n</h1>
            <p class="subtitle">Xem v√† qu·∫£n l√Ω th√¥ng tin c√° nh√¢n</p>
            
            <div class="profile-content" id="profile-content">
                <div class="loading-container">
                    <div class="loading"></div>
                    <p>ƒêang t·∫£i th√¥ng tin...</p>
                </div>
            </div>
            
            <div class="alert alert-error" id="error-msg" style="display: none;">
                <p id="error-text"></p>
                <button class="btn btn-primary" id="login-btn" style="display: none;">
                    üîê ƒêƒÉng nh·∫≠p
                </button>
            </div>
            
            <div class="nav-links">
                <a href="/static/home.html">üè† Trang ch·ªß</a>
                <a href="/static/products.html">üõí S·∫£n ph·∫©m</a>
                <a href="/static/info.html">‚úèÔ∏è S·ª≠a th√¥ng tin</a>
                <button onclick="logout()" class="btn btn-danger">üö™ ƒêƒÉng xu·∫•t</button>
            </div>
        </div>
    </div>

    <script>
        function getCookie(name) {
            return document.cookie.split("; ").reduce((r, v) => {
                const parts = v.split("=");
                return parts[0] === name ? decodeURIComponent(parts[1]) : r;
            }, "");
        }

        function deleteCookie(name) {
            document.cookie = name + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        }

        function logout() {
            if (confirm("ü§î B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?")) {
                deleteCookie("access_token");
                deleteCookie("refresh_token");
                deleteCookie("cart");
                alert("üëã ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!");
                window.location.href = "/static/landing_page.html";
            }
        }

        function showError(message) {
            const errorMsg = document.getElementById('error-msg');
            const errorText = document.getElementById('error-text');
            const loginBtn = document.getElementById('login-btn');
            const profileContent = document.getElementById('profile-content');

            profileContent.style.display = 'none';
            errorText.textContent = message;
            errorMsg.style.display = "block";
            loginBtn.style.display = "inline-block";

            loginBtn.onclick = function () {
                window.location.href = "/static/login.html";
            };
        }

        function displayProfile(data) {
            const profileContent = document.getElementById('profile-content');
            
            profileContent.innerHTML = `
                <div class="user-info">
                    <h3>üìã Th√¥ng tin c√° nh√¢n</h3>
                    <div class="profile-table">
                        <div class="profile-row">
                            <span class="profile-label">üë§ T√†i kho·∫£n:</span>
                            <span class="profile-value">${data.username || 'Ch∆∞a c·∫≠p nh·∫≠t'}</span>
                        </div>
                        <div class="profile-row">
                            <span class="profile-label">üìß Email:</span>
                            <span class="profile-value">${data.email || 'Ch∆∞a c·∫≠p nh·∫≠t'}</span>
                        </div>
                        <div class="profile-row">
                            <span class="profile-label">üë®‚Äçüíº H·ªç t√™n:</span>
                            <span class="profile-value">${data.name || 'Ch∆∞a c·∫≠p nh·∫≠t'}</span>
                        </div>
                        <div class="profile-row">
                            <span class="profile-label">üì± S·ªë ƒëi·ªán tho·∫°i:</span>
                            <span class="profile-value">${data.phone_number || 'Ch∆∞a c·∫≠p nh·∫≠t'}</span>
                        </div>
                        <div class="profile-row">
                            <span class="profile-label">üè† ƒê·ªãa ch·ªâ:</span>
                            <span class="profile-value">${data.address || 'Ch∆∞a c·∫≠p nh·∫≠t'}</span>
                        </div>
                        <div class="profile-row">
                            <span class="profile-label">üë• Vai tr√≤:</span>
                            <span class="profile-value role-badge">${data.role || 'User'}</span>
                        </div>
                        <div class="profile-row">
                            <span class="profile-label">üìÖ T·∫°o l√∫c:</span>
                            <span class="profile-value">${data.created_at ? new Date(data.created_at).toLocaleString('vi-VN') : 'Ch∆∞a r√µ'}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Simple JWT payload decoder (without verification)
        function parseJWT(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error('Error parsing JWT:', e);
                return null;
            }
        }

        async function loadProfile() {
            const token = getCookie("access_token");
            
            if (!token) {
                showError("‚ö†Ô∏è B·∫°n ph·∫£i ƒëƒÉng nh·∫≠p tr∆∞·ªõc!");
                return;
            }

            // Parse JWT to get username
            const payload = parseJWT(token);
            if (!payload || !payload.username) {
                showError("‚ùå Token kh√¥ng h·ª£p l·ªá. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!");
                return;
            }

            try {
                // Get basic account info using /account/list endpoint with cookie auth
                const response = await fetch('/profile', {
                    method: 'GET',
                    headers: { 
                        'Content-Type': 'application/json' 
                    },
                    credentials: 'include' // Use cookie authentication
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        showError("üîí Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n!");
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }

                const responseData = await response.json();
                console.log("‚úÖ Raw response received:", responseData);
                
                // Handle different response types
                let account;
                if (Array.isArray(responseData)) {
                    // Admin gets array of accounts, we want the current user's account
                    account = responseData.find(acc => acc.username === payload.username) || responseData[0];
                } else {
                    // Regular user gets single account object
                    account = responseData;
                }
                
                console.log("‚úÖ Selected account:", account);
                
                // Load additional account info - backend route is now GET /account_info/:id
                let accountInfo = null;
                
                // Try different ID approaches since backend expects account_info primary key ID
                const attempts = [
                    { id: account.id, desc: "Using account.id" },
                    { id: 1, desc: "Trying account_info ID 1" },
                    { id: 2, desc: "Trying account_info ID 2" },
                    { id: 3, desc: "Trying account_info ID 3" },
                    { id: 4, desc: "Trying account_info ID 4" },
                    { id: 5, desc: "Trying account_info ID 5" }
                ];

                for (const attempt of attempts) {
                    if (!attempt.id) continue;
                    
                    try {
                        console.log(`üåê ${attempt.desc}: /account_info/${attempt.id}`);
                        const infoResponse = await fetch(`/account_info/${attempt.id}`, {
                            method: 'GET',
                            headers: { 
                                'Content-Type': 'application/json' 
                            },
                            credentials: 'include'
                        });
                        
                        if (infoResponse.ok) {
                            accountInfo = await infoResponse.json();
                            console.log(`‚úÖ SUCCESS with ${attempt.desc}:`, accountInfo);
                            break; // Exit loop on success
                        } else {
                            console.log(`‚ùå ${attempt.desc} failed: ${infoResponse.status}`);
                        }
                    } catch (err) {
                        console.log(`‚ùå ${attempt.desc} error:`, err);
                    }
                }
                
                if (!accountInfo) {
                    console.warn('‚ùå All account_info attempts failed');
                }

                // Combine account and account_info data
                const combinedData = {
                    username: account.username || payload.username,
                    role: account.role || payload.role,
                    email: accountInfo?.email || "Ch∆∞a c·∫≠p nh·∫≠t",
                    name: accountInfo?.name || "Ch∆∞a c·∫≠p nh·∫≠t", 
                    phone_number: accountInfo?.phone_number || "Ch∆∞a c·∫≠p nh·∫≠t",
                    address: accountInfo?.address || "Ch∆∞a c·∫≠p nh·∫≠t",
                    created_at: account.created_at
                };

                displayProfile(combinedData);

            } catch (error) {
                console.error('Error loading profile:', error);
                showError(`‚ùå ƒê√£ c√≥ l·ªói x·∫£y ra: ${error.message}`);
            }
        }

        // Detect if background image loads successfully
        const img = new Image();
        img.onload = function() {
            document.body.classList.add('bg-loaded');
        };
        img.onerror = function() {
            console.log('‚ö†Ô∏è Background image bg.png not found, using gradient fallback');
        };
        img.src = '/static/images/bg.png';

        // Load profile when page loads
        loadProfile();
    </script>
</body>
</html> 